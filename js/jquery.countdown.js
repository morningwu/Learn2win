/* http://keith-wood.name/countdown.html
   Countdown for jQuery v1.5.4.
   Written by Keith Wood (kbwood{at}iinet.com.au) January 2008.
   Dual licensed under the GPL (http://dev.jquery.com/browser/trunk/jquery/GPL-LICENSE.txt) and 
   MIT (http://dev.jquery.com/browser/trunk/jquery/MIT-LICENSE.txt) licenses. 
   Please attribute the author if you use it. */

/* Display a countdown timer.
   Attach it with options like:
   $('div selector').countdown(
       {until: new Date(2009, 1 - 1, 1, 0, 0, 0), onExpiry: happyNewYear}); */
;(function(e){function t(){this.regional=[];this.regional[""]={labels:["Years","Months","Weeks","Days","Hours","Minutes","Seconds"],labels1:["Year","Month","Week","Day","Hour","Minute","Second"],compactLabels:["y","m","w","d"],timeSeparator:":",isRTL:false};this._defaults={until:null,since:null,timezone:null,serverSync:null,format:"dHMS",layout:"",compact:false,description:"",expiryUrl:"",expiryText:"",alwaysExpire:false,onExpiry:null,onTick:null};e.extend(this._defaults,this.regional[""])}function l(t,n){e.extend(t,n);for(var r in n){if(n[r]==null){t[r]=null}}return t}var n="countdown";var r=0;var i=1;var s=2;var o=3;var u=4;var a=5;var f=6;e.extend(t.prototype,{markerClassName:"hasCountdown",_timer:setInterval(function(){e.countdown._updateTargets()},980),_timerTargets:[],setDefaults:function(e){this._resetExtraLabels(this._defaults,e);l(this._defaults,e||{})},UTCDate:function(e,t,n,r,i,s,o,u){if(typeof t=="object"&&t.constructor==Date){u=t.getMilliseconds();o=t.getSeconds();s=t.getMinutes();i=t.getHours();r=t.getDate();n=t.getMonth();t=t.getFullYear()}var a=new Date;a.setUTCFullYear(t);a.setUTCDate(1);a.setUTCMonth(n||0);a.setUTCDate(r||1);a.setUTCHours(i||0);a.setUTCMinutes((s||0)-(Math.abs(e)<30?e*60:e));a.setUTCSeconds(o||0);a.setUTCMilliseconds(u||0);return a},_attachCountdown:function(t,r){var i=e(t);if(i.hasClass(this.markerClassName)){return}i.addClass(this.markerClassName);var s={options:e.extend({},r),_periods:[0,0,0,0,0,0,0]};e.data(t,n,s);this._changeCountdown(t)},_addTarget:function(e){if(!this._hasTarget(e)){this._timerTargets.push(e)}},_hasTarget:function(t){return e.inArray(t,this._timerTargets)>-1},_removeTarget:function(t){this._timerTargets=e.map(this._timerTargets,function(e){return e==t?null:e})},_updateTargets:function(){for(var e=0;e<this._timerTargets.length;e++){this._updateCountdown(this._timerTargets[e])}},_updateCountdown:function(t,r){var i=e(t);r=r||e.data(t,n);if(!r){return}i.html(this._generateHTML(r));i[(this._get(r,"isRTL")?"add":"remove")+"Class"]("countdown_rtl");var s=this._get(r,"onTick");if(s){s.apply(t,[r._hold!="lap"?r._periods:this._calculatePeriods(r,r._show,new Date)])}var o=r._hold!="pause"&&(r._since?r._now.getTime()<=r._since.getTime():r._now.getTime()>=r._until.getTime());if(o&&!r._expiring){r._expiring=true;if(this._hasTarget(t)||this._get(r,"alwaysExpire")){this._removeTarget(t);var u=this._get(r,"onExpiry");if(u){u.apply(t,[])}var a=this._get(r,"expiryText");if(a){var f=this._get(r,"layout");r.options.layout=a;this._updateCountdown(t,r);r.options.layout=f}var l=this._get(r,"expiryUrl");if(l){window.location=l}}r._expiring=false}else if(r._hold=="pause"){this._removeTarget(t)}e.data(t,n,r)},_changeCountdown:function(t,r,i){r=r||{};if(typeof r=="string"){var s=r;r={};r[s]=i}var o=e.data(t,n);if(o){this._resetExtraLabels(o.options,r);l(o.options,r);this._adjustSettings(t,o);e.data(t,n,o);var u=new Date;if(o._since&&o._since<u||o._until&&o._until>u){this._addTarget(t)}this._updateCountdown(t,o)}},_resetExtraLabels:function(e,t){var n=false;for(var r in t){if(r.match(/[Ll]abels/)){n=true;break}}if(n){for(var r in e){if(r.match(/[Ll]abels[0-9]/)){e[r]=null}}}},_adjustSettings:function(e,t){var n=this._get(t,"serverSync");n=n?n.apply(e,[]):null;var r=new Date;var i=this._get(t,"timezone");i=i==null?-r.getTimezoneOffset():i;t._since=this._get(t,"since");if(t._since){t._since=this.UTCDate(i,this._determineTime(t._since,null));if(t._since&&n){t._since.setMilliseconds(t._since.getMilliseconds()+r.getTime()-n.getTime())}}t._until=this.UTCDate(i,this._determineTime(this._get(t,"until"),r));if(n){t._until.setMilliseconds(t._until.getMilliseconds()+r.getTime()-n.getTime())}t._show=this._determineShow(t)},_destroyCountdown:function(t){var r=e(t);if(!r.hasClass(this.markerClassName)){return}this._removeTarget(t);r.removeClass(this.markerClassName).empty();e.removeData(t,n)},_pauseCountdown:function(e){this._hold(e,"pause")},_lapCountdown:function(e){this._hold(e,"lap")},_resumeCountdown:function(e){this._hold(e,null)},_hold:function(t,r){var i=e.data(t,n);if(i){if(i._hold=="pause"&&!r){i._periods=i._savePeriods;var s=i._since?"-":"+";i[i._since?"_since":"_until"]=this._determineTime(s+i._periods[0]+"y"+s+i._periods[1]+"o"+s+i._periods[2]+"w"+s+i._periods[3]+"d"+s+i._periods[4]+"h"+s+i._periods[5]+"m"+s+i._periods[6]+"s");this._addTarget(t)}i._hold=r;i._savePeriods=r=="pause"?i._periods:null;e.data(t,n,i);this._updateCountdown(t,i)}},_getTimesCountdown:function(t){var r=e.data(t,n);return!r?null:!r._hold?r._periods:this._calculatePeriods(r,r._show,new Date)},_get:function(t,n){return t.options[n]!=null?t.options[n]:e.countdown._defaults[n]},_determineTime:function(t,n){var r=function(e){var t=new Date;t.setTime(t.getTime()+e*1e3);return t};var i=function(t){t=t.toLowerCase();var n=new Date;var r=n.getFullYear();var i=n.getMonth();var s=n.getDate();var o=n.getHours();var u=n.getMinutes();var a=n.getSeconds();var f=/([+-]?[0-9]+)\s*(s|m|h|d|w|o|y)?/g;var l=f.exec(t);while(l){switch(l[2]||"s"){case"s":a+=parseInt(l[1],10);break;case"m":u+=parseInt(l[1],10);break;case"h":o+=parseInt(l[1],10);break;case"d":s+=parseInt(l[1],10);break;case"w":s+=parseInt(l[1],10)*7;break;case"o":i+=parseInt(l[1],10);s=Math.min(s,e.countdown._getDaysInMonth(r,i));break;case"y":r+=parseInt(l[1],10);s=Math.min(s,e.countdown._getDaysInMonth(r,i));break}l=f.exec(t)}return new Date(r,i,s,o,u,a,0)};var s=t==null?n:typeof t=="string"?i(t):typeof t=="number"?r(t):t;if(s)s.setMilliseconds(0);return s},_getDaysInMonth:function(e,t){return 32-(new Date(e,t,32)).getDate()},_generateHTML:function(t){t._periods=periods=t._hold?t._periods:this._calculatePeriods(t,t._show,new Date);var n=false;var l=0;for(var c=0;c<t._show.length;c++){n|=t._show[c]=="?"&&periods[c]>0;t._show[c]=t._show[c]=="?"&&!n?null:t._show[c];l+=t._show[c]?1:0}var h=this._get(t,"compact");var p=this._get(t,"layout");var d=h?this._get(t,"compactLabels"):this._get(t,"labels");var v=this._get(t,"timeSeparator");var m=this._get(t,"description")||"";var g=function(n){var r=e.countdown._get(t,"compactLabels"+periods[n]);return t._show[n]?periods[n]+(r?r[n]:d[n])+" ":""};var y=function(n){var r=e.countdown._get(t,"labels"+periods[n]);return t._show[n]?'<span class="countdown_section"><span class="countdown_amount">'+periods[n]+"</span><br/>"+(r?r[n]:d[n])+"</span>":""};return p?this._buildLayout(t,p,h):(h?'<span class="countdown_row countdown_amount'+(t._hold?" countdown_holding":"")+'">'+g(r)+g(i)+g(s)+g(o)+(t._show[u]?this._minDigits(periods[u],2):"")+(t._show[a]?(t._show[u]?v:"")+this._minDigits(periods[a],2):"")+(t._show[f]?(t._show[u]||t._show[a]?v:"")+this._minDigits(periods[f],2):""):'<span class="countdown_row countdown_show'+l+(t._hold?" countdown_holding":"")+'">'+y(r)+y(i)+y(s)+y(o)+y(u)+y(a)+y(f))+"</span>"+(m?'<span class="countdown_row countdown_descr">'+m+"</span>":"")},_buildLayout:function(t,n,l){var c=this._get(t,l?"compactLabels":"labels");var h=function(n){return(e.countdown._get(t,(l?"compactLabels":"labels")+t._periods[n])||c)[n]};var p=function(e,t){return Math.floor(e/t)%10};var d={desc:this._get(t,"description"),sep:this._get(t,"timeSeparator"),yl:h(r),yn:t._periods[r],ynn:this._minDigits(t._periods[r],2),ynnn:this._minDigits(t._periods[r],3),y1:p(t._periods[r],1),y10:p(t._periods[r],10),y100:p(t._periods[r],100),ol:h(i),on:t._periods[i],onn:this._minDigits(t._periods[i],2),onnn:this._minDigits(t._periods[i],3),o1:p(t._periods[i],1),o10:p(t._periods[i],10),o100:p(t._periods[i],100),wl:h(s),wn:t._periods[s],wnn:this._minDigits(t._periods[s],2),wnnn:this._minDigits(t._periods[s],3),w1:p(t._periods[s],1),w10:p(t._periods[s],10),w100:p(t._periods[s],100),dl:h(o),dn:t._periods[o],dnn:this._minDigits(t._periods[o],2),dnnn:this._minDigits(t._periods[o],3),d1:p(t._periods[o],1),d10:p(t._periods[o],10),d100:p(t._periods[o],100),hl:h(u),hn:t._periods[u],hnn:this._minDigits(t._periods[u],2),hnnn:this._minDigits(t._periods[u],3),h1:p(t._periods[u],1),h10:p(t._periods[u],10),h100:p(t._periods[u],100),ml:h(a),mn:t._periods[a],mnn:this._minDigits(t._periods[a],2),mnnn:this._minDigits(t._periods[a],3),m1:p(t._periods[a],1),m10:p(t._periods[a],10),m100:p(t._periods[a],100),sl:h(f),sn:t._periods[f],snn:this._minDigits(t._periods[f],2),snnn:this._minDigits(t._periods[f],3),s1:p(t._periods[f],1),s10:p(t._periods[f],10),s100:p(t._periods[f],100)};var v=n;for(var m=0;m<7;m++){var g="yowdhms".charAt(m);var y=new RegExp("\\{"+g+"<\\}(.*)\\{"+g+">\\}","g");v=v.replace(y,t._show[m]?"$1":"")}e.each(d,function(e,t){var n=new RegExp("\\{"+e+"\\}","g");v=v.replace(n,t)});return v},_minDigits:function(e,t){e="0000000000"+e;return e.substr(e.length-t)},_determineShow:function(e){var t=this._get(e,"format");var n=[];n[r]=t.match("y")?"?":t.match("Y")?"!":null;n[i]=t.match("o")?"?":t.match("O")?"!":null;n[s]=t.match("w")?"?":t.match("W")?"!":null;n[o]=t.match("d")?"?":t.match("D")?"!":null;n[u]=t.match("h")?"?":t.match("H")?"!":null;n[a]=t.match("m")?"?":t.match("M")?"!":null;n[f]=t.match("s")?"?":t.match("S")?"!":null;return n},_calculatePeriods:function(t,n,l){t._now=l;t._now.setMilliseconds(0);var c=new Date(t._now.getTime());if(t._since&&l.getTime()<t._since.getTime()){t._now=l=c}else if(t._since){l=t._since}else{c.setTime(t._until.getTime());if(l.getTime()>t._until.getTime()){t._now=l=c}}var h=[0,0,0,0,0,0,0];if(n[r]||n[i]){var p=e.countdown._getDaysInMonth(l.getFullYear(),l.getMonth());var d=e.countdown._getDaysInMonth(c.getFullYear(),c.getMonth());var v=c.getDate()==l.getDate()||c.getDate()>=Math.min(p,d)&&l.getDate()>=Math.min(p,d);var m=function(e){return(e.getHours()*60+e.getMinutes())*60+e.getSeconds()};var g=Math.max(0,(c.getFullYear()-l.getFullYear())*12+c.getMonth()-l.getMonth()+(c.getDate()<l.getDate()&&!v||v&&m(c)<m(l)?-1:0));h[r]=n[r]?Math.floor(g/12):0;h[i]=n[i]?g-h[r]*12:0;var y=function(t,n,s){var o=t.getDate()==s;var u=e.countdown._getDaysInMonth(t.getFullYear()+n*h[r],t.getMonth()+n*h[i]);if(t.getDate()>u){t.setDate(u)}t.setFullYear(t.getFullYear()+n*h[r]);t.setMonth(t.getMonth()+n*h[i]);if(o){t.setDate(u)}return t};if(t._since){c=y(c,-1,d)}else{l=y(new Date(l.getTime()),+1,p)}}var b=Math.floor((c.getTime()-l.getTime())/1e3);var w=function(e,t){h[e]=n[e]?Math.floor(b/t):0;b-=h[e]*t};w(s,604800);w(o,86400);w(u,3600);w(a,60);w(f,1);return h}});e.fn.countdown=function(t){var n=Array.prototype.slice.call(arguments,1);if(t=="getTimes"){return e.countdown["_"+t+"Countdown"].apply(e.countdown,[this[0]].concat(n))}return this.each(function(){if(typeof t=="string"){e.countdown["_"+t+"Countdown"].apply(e.countdown,[this].concat(n))}else{e.countdown._attachCountdown(this,t)}})};e.countdown=new t})(jQuery);